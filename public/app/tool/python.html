<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Online Compiler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <!-- Ace Editor for VS Code-like experience -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Inter:wght@300;400;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        .code-font {
            font-family: 'Fira Code', monospace;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Ace Editor Customization */
        #editor { 
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            font-family: 'Fira Code', monospace;
            font-size: 12px; /* Force editor font size */
            line-height: 1.5; /* Consistent line height */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shrink-0 shadow-md z-10 relative">
        <div class="flex items-center space-x-3">
            <i class="fab fa-python text-3xl text-yellow-400"></i>
            <div>
                <h1 class="text-xl font-bold text-white">Python Online Compiler</h1>
                <p class="text-xs text-gray-400">Powered by Kruboat.com</p>
            </div>
        </div>
        
        <div class="flex items-center space-x-3">
            <div id="status-indicator" class="flex items-center space-x-2 text-yellow-500 text-sm hidden md:flex">
                <div class="loader"></div>
                <span>Loading Python...</span>
            </div>
            
            <button onclick="runPython()" id="run-btn" disabled 
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center space-x-2 font-bold transition opacity-50 cursor-not-allowed shadow-lg">
                <i class="fas fa-play"></i>
                <span>Run</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Editor Section -->
        <div class="flex-1 flex flex-col border-r border-gray-700 min-h-[50%] md:min-h-full relative">
            <div class="bg-[#252526] px-4 py-2 text-xs text-gray-400 font-mono border-b border-black flex justify-between items-center shrink-0 h-[33px]">
                <span class="flex items-center"><i class="fab fa-python mr-2 text-blue-400"></i> main.py</span>
                
                <div class="flex space-x-2">
                    <!-- Save Button -->
                    <button type="button" onclick="openSaveModal()" class="hover:text-white text-gray-400 transition flex items-center p-1 rounded hover:bg-gray-700" title="Save File">
                        <i class="fas fa-save mr-1"></i> Save
                    </button>
                    <!-- Clear Button -->
                    <button type="button" onclick="clearEditor()" class="hover:text-white text-gray-400 transition flex items-center p-1 rounded hover:bg-gray-700" title="Clear Code">
                        <i class="fas fa-trash-alt mr-1"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Container for Ace Editor -->
            <div class="relative flex-1 bg-[#1e1e1e]">
                <div id="editor"># Welcome to Python Online Compiler
# Powered by Kruboat.com
# Code > Run > Save > Good luck
print ("kruboat.com/app/tool/python")
</div>
            </div>
        </div>

        <!-- Output Section -->
        <div class="flex-1 flex flex-col min-h-[40%] md:min-h-full bg-[#1e1e1e] border-t-4 md:border-t-0 border-gray-700 shadow-2xl z-10">
            <div class="bg-[#252526] px-4 py-2 text-xs text-gray-400 font-mono border-b border-black flex justify-between items-center shrink-0 h-[33px]">
                <span>TERMINAL</span>
                <button onclick="clearOutput()" class="hover:text-white transition"><i class="fas fa-eraser mr-1"></i> Clear</button>
            </div>
            <!-- Modified: Changed p-4 to px-4 pb-4 pt-0 to align first line with Ace Editor -->
            <div id="output" class="code-font flex-1 px-4 pb-4 pt-0 overflow-y-auto text-[12px] leading-[1.5] whitespace-pre-wrap font-mono text-gray-300 bg-[#1e1e1e]">
                <div class="text-gray-500 italic">Waiting for output...</div>
            </div>
        </div>
    </main>

    <footer class="bg-[#007acc] text-white text-xs p-1 px-4 flex justify-between items-center shrink-0 z-20">
        <div><i class="fas fa-code-branch"></i> main</div>
        <div class="flex space-x-4">
            <span>Ln 1, Col 1</span>
            <span>UTF-8</span>
            <span>Python</span>
        </div>
    </footer>

    <!-- Custom Confirmation Modal (Clear) -->
    <div id="clear-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-[#252526] p-6 rounded-lg shadow-2xl border border-gray-700 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-white mb-2 flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> Confirm Clear
            </h3>
            <p class="text-gray-300 mb-6 text-sm">Are you sure you want to clear all code? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded transition">
                    Cancel
                </button>
                <button onclick="confirmClear()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded font-bold transition shadow-lg">
                    Clear Code
                </button>
            </div>
        </div>
    </div>

    <!-- Save File Modal -->
    <div id="save-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-[#252526] p-6 rounded-lg shadow-2xl border border-gray-700 max-w-sm w-full mx-4">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                <i class="fas fa-save text-blue-500 mr-2"></i> Save File
            </h3>
            <div class="mb-4">
                <label class="block text-gray-400 text-xs mb-2">File Name</label>
                <input type="text" id="filename-input" value="main.py" class="w-full bg-[#1e1e1e] border border-gray-600 text-gray-200 text-sm rounded p-2 focus:border-blue-500 focus:outline-none placeholder-gray-500" placeholder="example.py">
                <p class="text-gray-500 text-xs mt-1">* .py extension will be added automatically.</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeSaveModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded transition">
                    Cancel
                </button>
                <button onclick="confirmSave()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded font-bold transition shadow-lg flex items-center">
                    <i class="fas fa-download mr-1"></i> Download
                </button>
            </div>
        </div>
    </div>

    <script>
        let pyodide;
        let aceEditor;
        const outputDiv = document.getElementById("output");
        const runBtn = document.getElementById("run-btn");
        const statusIndicator = document.getElementById("status-indicator");
        
        // Modals
        const modal = document.getElementById("clear-modal");
        const saveModal = document.getElementById("save-modal");
        const filenameInput = document.getElementById("filename-input");

        // Initialize Ace Editor immediately
        function initEditor() {
            try {
                aceEditor = ace.edit("editor");
                aceEditor.setTheme("ace/theme/tomorrow_night");
                aceEditor.session.setMode("ace/mode/python");
                aceEditor.setOptions({
                    fontSize: "12px", 
                    enableBasicAutocompletion: true,
                    enableLiveAutocompletion: true,
                    showPrintMargin: false,
                    displayIndentGuides: true,
                    highlightActiveLine: true,
                    showLineNumbers: true,
                    tabSize: 4,
                    useSoftTabs: true
                });
                
                aceEditor.selection.on('changeCursor', function() {
                    const pos = aceEditor.selection.getCursor();
                    const footerInfo = document.querySelector('footer div.flex span:first-child');
                    if(footerInfo) footerInfo.textContent = `Ln ${pos.row + 1}, Col ${pos.column + 1}`;
                });
                console.log("Ace Editor initialized");
            } catch (e) {
                console.error("Ace Editor initialization failed:", e);
            }
        }

        initEditor();

        // Initialize Python (Pyodide)
        async function main() {
            try {
                pyodide = await loadPyodide();
                
                statusIndicator.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> <span class="text-green-400">Ready</span>';
                runBtn.disabled = false;
                runBtn.classList.remove("opacity-50", "cursor-not-allowed");
                
                console.log("Pyodide loaded successfully");
            } catch (err) {
                statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> <span class="text-red-500">Error Loading</span>';
                console.error(err);
            }
        }

        main();

        function addToOutput(text, isError = false) {
            if (outputDiv.querySelector('.text-gray-500.italic')) {
                outputDiv.innerHTML = '';
            }

            const span = document.createElement('span');
            span.textContent = text;
            if (isError) {
                span.className = "text-red-400 block";
            }
            outputDiv.appendChild(span);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function clearOutput() {
            outputDiv.innerHTML = '<div class="text-gray-500 italic">Waiting for output...</div>';
        }

        // --- Clear Modal Functions ---
        function clearEditor() {
            if (!aceEditor) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function confirmClear() {
            if (aceEditor) {
                aceEditor.setValue("", -1);
                aceEditor.focus();
            }
            closeModal();
        }

        // --- Save Modal Functions ---
        function openSaveModal() {
            if (!aceEditor) return;
            saveModal.classList.remove('hidden');
            saveModal.classList.add('flex');
            // Reset input and focus
            filenameInput.value = "main.py";
            setTimeout(() => {
                filenameInput.focus();
                filenameInput.select();
            }, 100);
        }

        function closeSaveModal() {
            saveModal.classList.add('hidden');
            saveModal.classList.remove('flex');
        }

        function confirmSave() {
            if (!aceEditor) return;
            
            let filename = filenameInput.value.trim();
            // Default filename
            if (!filename) filename = "main.py";
            // Auto append extension
            if (!filename.endsWith(".py")) filename += ".py";

            const codeContent = aceEditor.getValue();
            
            // Create Blob and Download Link
            const blob = new Blob([codeContent], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            
            // Cleanup
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            closeSaveModal();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
            if (event.target == saveModal) {
                closeSaveModal();
            }
        }
        
        // Allow Enter key in filename input to submit
        filenameInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                confirmSave();
            }
        });

        async function runPython() {
            if (!aceEditor) return;
            
            const code = aceEditor.getValue();
            if (!code.trim()) return;

            runBtn.disabled = true;
            runBtn.innerHTML = '<div class="loader w-4 h-4 border-2 border-white border-t-transparent mr-2"></div> Running...';
            
            clearOutput(); 

            try {
                pyodide.setStdout({ batched: (msg) => addToOutput(msg + "\n") });
                pyodide.setStderr({ batched: (msg) => addToOutput(msg + "\n", true) });

                await pyodide.runPythonAsync(code);

            } catch (err) {
                addToOutput(err, true);
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<i class="fas fa-play"></i> <span>Run</span>';
            }
        }
    </script>
</body>
</html>