<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomMate - Student App</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4MQ3GL6CTB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-4MQ3GL6CTB');
    </script>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíª</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary-color: #6366f1; --secondary-color: #ec4899; --bg-color: #f3f4f6; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --fab-text-bg: #374151; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 100px; }
        .mobile-container { max-width: 480px; margin: 0 auto; background-color: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        .app-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; margin-bottom: 20px; position: relative; }
        .profile-section img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); object-fit: cover; background: white; }
        .xp-bar { height: 8px; background-color: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .xp-progress { height: 100%; background-color: #fbbf24; width: 0%; transition: width 0.5s; }
        .custom-card { border: none; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 15px; overflow: hidden; background: white; }
        .card-header-custom { padding: 12px 15px; font-weight: 600; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .schedule-item { padding: 12px 15px; border-left: 4px solid #e5e7eb; margin-bottom: 8px; background-color: #f9fafb; border-radius: 0 8px 8px 0; transition: all 0.3s; }
        .schedule-item.active { border-left: 4px solid var(--primary-color); background-color: #eef2ff; transform: translateX(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .time-badge { font-size: 0.7rem; color: #6b7280; display: block; margin-bottom: 2px; font-weight: 500; }
        .subject-code { font-size: 0.7rem; background: #e0e7ff; color: #4338ca; padding: 1px 6px; border-radius: 4px; margin-right: 5px; font-weight: 600; }
        .teacher-room { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }
        .hw-item { border-left: 4px solid transparent; position: relative; }
        .hw-urgent { border-left-color: #ef4444; }
        .hw-normal { border-left-color: #fbbf24; }
        .hw-done { border-left-color: #10b981; opacity: 0.6; }
        .btn-delete-hw { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #9ca3af; cursor: pointer; }
        .btn-delete-hw:hover { color: #ef4444; }
        .fab-container { position: fixed; bottom: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .fab-trigger { width: 45px; height: 45px; background-color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 18px; cursor: pointer; border: none; transition: all 0.3s; }
        .fab-menu { display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; opacity: 0; pointer-events: none; transform: translateY(10px); transition: all 0.3s ease-in-out; margin-bottom: 5px; }
        .fab-container.active .fab-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .fab-item { display: flex; align-items: center; justify-content: flex-end; gap: 10px; text-decoration: none; cursor: pointer; }
        .fab-item-btn { width: 35px; height: 35px; background-color: white; border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 14px; transition: background-color 0.2s; }
        .fab-item-label { background-color: var(--fab-text-bg); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.15); opacity: 0.9; font-weight: 400; }
        .fab-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .fab-container.active ~ .fab-overlay { opacity: 1; pointer-events: auto; }
        .add-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: none; }
        
        .teacher-btn { position: absolute; top: 20px; right: 20px; color: rgba(255,255,255,0.8); cursor: pointer; z-index: 50; padding: 8px; border-radius: 50%; transition: background 0.3s; }
        .teacher-btn:hover { color: white; background: rgba(255,255,255,0.2); }
        
        .xp-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #fbbf24; color: #78350f; font-weight: bold; margin-left: 5px;}
        .student-list-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
        .nav-pills .nav-link { color: #6b7280; background-color: #f3f4f6; margin: 0 2px; }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        
        .game-card { cursor: pointer; transition: transform 0.2s; }
        .game-card:hover { transform: translateY(-3px); }
        .game-icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 8px; }
        .game-frame { width: 100%; height: 100%; border: none; border-radius: 12px; }
    </style>
</head>
<body>

<div class="mobile-container">
    <!-- Header -->
    <header class="app-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="fw-bold fs-5"><i class="fa-solid fa-shapes me-2"></i>RoomMate</div>
        </div>
        <div class="teacher-btn" onclick="unlockTeacherMode()"><i class="fa-solid fa-gear fa-lg"></i></div>

        <div class="d-flex align-items-center profile-section">
            <img src="https://ui-avatars.com/api/?name=Guest&background=random" alt="Profile" id="student-img">
            <div class="ms-3 flex-grow-1">
                <div class="fw-bold" id="student-name">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô</div>
                
                <div id="student-stats" class="d-none">
                    <div class="d-flex justify-content-between align-items-end" style="font-size: 0.8rem;">
                        <span id="student-lvl">Lv. 1</span>
                        <span id="student-xp">0 XP</span>
                    </div>
                    <div class="xp-bar"><div class="xp-progress" id="student-xp-bar" style="width: 0%"></div></div>
                </div>

                <div id="guest-login-btn">
                    <button class="btn btn-sm btn-white text-primary fw-bold rounded-pill px-3 mt-1 shadow-sm" onclick="openRegisterModal()" style="background: rgba(255,255,255,0.9); border:none;">
                        <i class="fa-solid fa-right-to-bracket me-1"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container px-3">
        <!-- Schedule Card -->
        <div class="custom-card mt-3">
            <div class="card-header-custom"><span><i class="fa-regular fa-calendar-days me-2 text-primary"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span class="badge bg-primary rounded-pill" id="today-day">-</span></div>
            <div class="p-3" id="schedule-list"><div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</div></div>
        </div>

        <!-- Duty Card -->
        <div class="custom-card border-0" style="background: linear-gradient(to right, #fff1eb, #ace0f9);">
            <div class="card-header-custom bg-transparent border-0"><span><i class="fa-solid fa-broom me-2 text-success"></i>‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span><div class="d-flex align-items-center gap-2"><button class="btn btn-light btn-sm rounded-pill px-3 py-1 border-0 shadow-sm text-success fw-bold" style="font-size: 0.7rem;" onclick="openDutyRosterModal()"><i class="fa-solid fa-users-viewfinder me-1"></i> ‡∏î‡∏π‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button><span class="badge bg-success" id="duty-group">-</span></div></div>
            <div class="p-3 pt-0"><div class="d-flex justify-content-between align-items-center"><div id="duty-members"><small class="text-muted d-block mb-1">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</small><div id="duty-list-text" class="small text-dark fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div><button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="triggerCamera()"><i class="fa-solid fa-camera me-1"></i> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button><input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="uploadDutyPhoto(this)"></div></div>
        </div>

        <!-- Homework List -->
        <div class="d-flex justify-content-between align-items-center mb-2 mt-4"><h6 class="fw-bold m-0"><i class="fa-solid fa-pen-to-square me-2 text-warning"></i>‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h6><button class="btn btn-dark add-btn shadow-sm" data-bs-toggle="modal" data-bs-target="#addHomeworkModal"><i class="fa-solid fa-plus"></i></button></div>
        <div id="homework-list"><div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>

        <!-- Game Center -->
        <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
            <h6 class="fw-bold m-0 text-primary"><i class="fa-solid fa-gamepad me-2"></i>Game Center</h6>
        </div>
        <div id="game-list-container" class="row g-2 pb-4">
             <div class="col-12 text-center py-3 text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°...</div>
        </div>
    </div>
    <div style="height: 60px;"></div>
</div>

<!-- FAB Menu -->
<div class="fab-container" id="fabMenu">
    <div class="fab-menu">
        <div class="fab-item" onclick="logoutStudent()"><span class="fab-item-label">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span><div class="fab-item-btn bg-danger text-white"><i class="fa-solid fa-right-from-bracket"></i></div></div>
        <a href="../student/index.html" class="fab-item"><span class="fab-item-label">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span><div class="fab-item-btn"><i class="fa-solid fa-house"></i></div></a>
    </div>
    <button class="fab-trigger" onclick="toggleFab()"><i class="fa-solid fa-bars"></i></button>
</div>
<div class="fab-overlay" onclick="toggleFab()"></div>

<!-- Game Launcher Modal -->
<div class="modal fade" id="gameLauncherModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0 py-2 bg-dark text-white">
                <h6 class="modal-title fw-bold" id="launcher-title">Loading...</h6>
                <button type="button" class="btn-close btn-close-white" onclick="closeGameLauncher()"></button>
            </div>
            <div class="modal-body p-0" style="height: 100%;">
                <iframe id="game-frame" src="" class="game-frame" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Other Modals (Duty, Register, HW, Teacher) -->
<div class="modal fade" id="dutyRosterModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content rounded-4 border-0" style="min-height: 500px;"><div class="modal-header border-0 bg-success text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-broom me-2"></i>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><ul class="nav nav-pills nav-fill mb-3 gap-1 small" id="duty-tabs" role="tablist"><li class="nav-item"><button class="nav-link active rounded-pill py-1" id="d-mon-tab" data-bs-toggle="pill" data-bs-target="#d-mon">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</button></li><li class="nav-item"><button class="nav-link rounded-pill py-1" id="d-tue-tab" data-bs-toggle="pill" data-bs-target="#d-tue">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</button></li><li class="nav-item"><button class="nav-link rounded-pill py-1" id="d-wed-tab" data-bs-toggle="pill" data-bs-target="#d-wed">‡∏û‡∏∏‡∏ò</button></li><li class="nav-item"><button class="nav-link rounded-pill py-1" id="d-thu-tab" data-bs-toggle="pill" data-bs-target="#d-thu">‡∏û‡∏§‡∏´‡∏±‡∏™</button></li><li class="nav-item"><button class="nav-link rounded-pill py-1" id="d-fri-tab" data-bs-toggle="pill" data-bs-target="#d-fri">‡∏®‡∏∏‡∏Å‡∏£‡πå</button></li></ul><div class="tab-content" id="duty-tabContent"><div class="tab-pane fade show active" id="d-mon"></div><div class="tab-pane fade" id="d-tue"></div><div class="tab-pane fade" id="d-wed"></div><div class="tab-pane fade" id="d-thu"></div><div class="tab-pane fade" id="d-fri"></div></div></div></div></div></div>
<div class="modal fade" id="studentRegisterModal" data-bs-backdrop="static" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 p-4 text-center"><div class="mb-3"><i class="fa-solid fa-user-lock text-5xl text-primary"></i></div><h4 class="fw-bold mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà RoomMate!</h4><p class="text-muted small mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p><input type="text" id="reg-student-id" class="form-control text-center mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 12345)"><button class="btn btn-primary w-100 rounded-pill" onclick="registerStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div></div>

<!-- Add Homework Modal (Fix Save Button) -->
<div class="modal fade" id="addHomeworkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="hw-form">
                    <div class="mb-3"><label class="form-label small text-muted">‡∏ß‡∏¥‡∏ä‡∏≤</label><input type="text" id="hw-subject" class="form-control form-control-sm bg-light border-0"></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="hw-desc" class="form-control form-control-sm bg-light border-0" rows="2"></textarea></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label><input type="date" id="hw-date" class="form-control form-control-sm bg-light border-0"></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label><select id="hw-type" class="form-select form-select-sm bg-light border-0"><option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="urgent">‡∏î‡πà‡∏ß‡∏ô</option></select></div>
                    <button type="button" class="btn btn-primary w-100 rounded-pill btn-sm" onclick="saveHomework()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="teacherLoginModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content rounded-4 border-0"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="password" id="teacher-pin" class="form-control form-control-lg text-center tracking-widest mb-3" placeholder="PIN" maxlength="4"><button class="btn btn-primary w-100 rounded-pill" onclick="checkTeacherPin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div></div></div></div>
<div class="modal fade" id="teacherDashboardModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content rounded-4 border-0" style="min-height: 600px;"><div class="modal-header border-0 bg-primary text-white"><h6 class="modal-title fw-bold" id="teacher-modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light p-0"><div id="teacher-menu" class="p-3"><div class="d-grid gap-2"><button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="showSection('teacher-students')"><i class="fa-solid fa-users me-2 text-success"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button><button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="showSection('teacher-schedule')"><i class="fa-solid fa-calendar-days me-2 text-primary"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button><button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="viewDutyHistory()"><i class="fa-solid fa-images me-2 text-warning"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£</button></div></div><div id="teacher-students" class="d-none h-100 d-flex flex-column"><div class="p-2 border-bottom bg-white d-flex align-items-center"><button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button><span class="fw-bold small">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></div><div class="p-3 bg-white border-bottom"><div class="mb-2"><input type="text" id="new-student-id" class="form-control form-control-sm mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß"><input type="text" id="new-student-name" class="form-control form-control-sm mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"><select id="new-student-group" class="form-select form-select-sm mb-2"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏£ --</option><option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3">‡∏û‡∏∏‡∏ò</option><option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™</option><option value="5">‡∏®‡∏∏‡∏Å‡∏£‡πå</option></select><input type="file" id="new-student-photo" class="form-control form-control-sm mb-2" accept="image/*"><button id="btn-add-student" class="btn btn-success btn-sm w-100 rounded-pill" onclick="addStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div></div><div id="student-list-container" class="p-2 overflow-auto flex-grow-1"></div></div><div id="teacher-schedule" class="d-none h-100 d-flex flex-column"><div class="p-2 border-bottom bg-white d-flex align-items-center"><button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button><span class="fw-bold small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></div><div class="p-3 overflow-auto flex-grow-1"><div class="mb-3"><label class="form-label small fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label><select id="edit-day-select" class="form-select form-select-sm" onchange="loadScheduleForDay()"><option value="mon">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="tue">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="wed">‡∏û‡∏∏‡∏ò</option><option value="thu">‡∏û‡∏§‡∏´‡∏±‡∏™</option><option value="fri">‡∏®‡∏∏‡∏Å‡∏£‡πå</option></select></div><div id="period-forms-container" class="space-y-3"></div><button class="btn btn-primary w-100 rounded-pill btn-sm mt-3" onclick="saveScheduleByDay()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div><div id="duty-photo-gallery" class="d-none h-100 d-flex flex-column"><div class="p-2 border-bottom bg-white d-flex align-items-center"><button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button><span class="fw-bold small">‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£</span></div><div id="gallery-grid" class="d-grid gap-2 p-2 overflow-auto" style="grid-template-columns: 1fr 1fr;"></div></div></div></div></div>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, serverTimestamp, getDoc, updateDoc, setDoc, limit, where, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ‚ö†Ô∏è Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
    const firebaseConfig = {
        apiKey: "AIzaSyAlfZHbCFxGK3p3nDoAPy3m9KqZzmX2s9I",
        authDomain: "kruboat-web.firebaseapp.com",
        projectId: "kruboat-web",
        storageBucket: "kruboat-web.firebasestorage.app",
        messagingSenderId: "61868765546",
        appId: "1:61868765546:web:683b18ddf68c89dd317513"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUserData = null;
    let currentStudentId = null;

    // --- Core Logic ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const storedId = localStorage.getItem('roommate_student_id');
            if (storedId) {
                currentStudentId = storedId;
                loadUserProfile(storedId);
                document.getElementById('student-stats').classList.remove('d-none');
                document.getElementById('guest-login-btn').classList.add('d-none');
            } else {
                document.getElementById('student-stats').classList.add('d-none');
                document.getElementById('guest-login-btn').classList.remove('d-none');
            }
        } else {
            signInAnonymously(auth).catch(console.error);
        }
    });
    
    window.openRegisterModal = () => new bootstrap.Modal(document.getElementById('studentRegisterModal')).show();

    window.registerStudent = async () => {
        const id = document.getElementById('reg-student-id').value.trim();
        if(!id) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
        const docRef = doc(db, "rm_students", id);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            localStorage.setItem('roommate_student_id', id);
            bootstrap.Modal.getInstance(document.getElementById('studentRegisterModal')).hide();
            currentStudentId = id;
            loadUserProfile(id);
            location.reload();
        } else {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    async function loadUserProfile(id) {
        const userRef = doc(db, "rm_students", id);
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                updateProfileUI();
            } else {
                localStorage.removeItem('roommate_student_id');
                location.reload();
            }
        });
    }

    function getLevelInfo(xp) {
        const level = Math.min(50, Math.floor(xp / 100) + 1);
        const currentLevelXp = xp % 100;
        const nextLevelXp = 100;
        let rank = "üå± ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô";
        if (level >= 10) rank = "üê£ ‡∏ú‡∏π‡πâ‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î";
        if (level >= 20) rank = "üèπ ‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢";
        if (level >= 30) rank = "‚öîÔ∏è ‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô";
        if (level >= 40) rank = "üëë ‡∏£‡∏≤‡∏ä‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤";
        if (level >= 50) rank = "üåü ‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤";
        return { level, rank, currentLevelXp, nextLevelXp };
    }

    function updateProfileUI() {
        if(!currentUserData) return;
        document.getElementById('student-name').innerText = currentUserData.name;
        const imgUrl = currentUserData.photoURL ? currentUserData.photoURL : `https://ui-avatars.com/api/?name=${currentUserData.name}&background=random`;
        document.getElementById('student-img').src = imgUrl;

        const rawXP = Number(currentUserData.xp) || 0;
        const { level, rank, currentLevelXp, nextLevelXp } = getLevelInfo(rawXP);

        document.getElementById('student-lvl').innerHTML = `Lv. ${level} <small class="opacity-75">(${rank})</small>`;
        document.getElementById('student-xp').innerText = `${currentLevelXp}/${nextLevelXp} XP`;
        
        const percentage = level >= 50 ? 100 : (currentLevelXp / nextLevelXp) * 100;
        document.getElementById('student-xp-bar').style.width = `${percentage}%`;
    }
    
    window.logoutStudent = () => {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            localStorage.removeItem('roommate_student_id');
            location.reload();
        }
    }

    // --- GAME STORE ---
    const gameListContainer = document.getElementById('game-list-container');
    const qGames = query(collection(db, "rm_games"), where("status", "==", "active"));
    
    onSnapshot(qGames, (snap) => {
        if(snap.empty) {
            gameListContainer.innerHTML = '<div class="col-12 text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏°</div>';
            return;
        }
        let html = '';
        snap.forEach(docSnap => {
            const g = docSnap.data();
            html += `
            <div class="col-4">
                <div class="custom-card bg-white border-0 h-100 shadow-sm game-card" onclick="launchGame('${g.url}', '${g.name}')">
                    <div class="p-2 text-center">
                        <div class="game-icon-box mx-auto" style="background-color: ${g.color || '#e0e7ff'}; color: ${g.iconColor || '#4f46e5'};">
                            ${g.icon || 'üéÆ'}
                        </div>
                        <h6 class="fw-bold mb-0 text-dark" style="font-size: 0.75rem;">${g.name}</h6>
                    </div>
                </div>
            </div>`;
        });
        gameListContainer.innerHTML = html;
    });

    window.launchGame = (url, title) => {
        if(currentUserData && currentUserData.lastGamePlayed) {
            const lastPlayed = currentUserData.lastGamePlayed.toDate();
            const diffMin = (new Date() - lastPlayed) / 60000;
            if(diffMin < 5) {
                return alert(`‚è≥ ‡∏û‡∏±‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞! ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${Math.ceil(5 - diffMin)} ‡∏ô‡∏≤‡∏ó‡∏µ`);
            }
        }
        
        document.getElementById('launcher-title').innerText = title;
        document.getElementById('game-frame').src = url; // ‡∏õ‡∏£‡∏±‡∏ö Path ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        new bootstrap.Modal(document.getElementById('gameLauncherModal')).show();
        window.addEventListener('message', handleGameMessage);
    }

    window.closeGameLauncher = () => {
        bootstrap.Modal.getInstance(document.getElementById('gameLauncherModal')).hide();
        document.getElementById('game-frame').src = "";
        window.removeEventListener('message', handleGameMessage);
    }

    function handleGameMessage(event) {
        const data = event.data;
        if(data.type === 'GAME_COMPLETE' && data.xp > 0) {
            grantXP(data.xp);
            window.closeGameLauncher();
        }
    }

    function grantXP(amount) {
        if(!currentStudentId) return;
        const todayStr = new Date().toISOString().split('T')[0];
        const currentDaily = (currentUserData.lastGameDate === todayStr) ? (currentUserData.dailyGameXP || 0) : 0;
        
        if(currentDaily < 50) {
            const canEarn = Math.min(amount, 50 - currentDaily);
            if(canEarn > 0) {
                 updateDoc(doc(db, "rm_students", currentStudentId), {
                     xp: increment(canEarn),
                     dailyGameXP: currentDaily === 0 ? canEarn : increment(canEarn),
                     lastGameDate: todayStr,
                     lastGamePlayed: serverTimestamp()
                 });
                 alert(`üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö +${canEarn} XP`);
            } else { alert("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö XP ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß (50/50)"); }
        } else { alert("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö XP ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"); }
    }

    // --- Schedule & Duty ---
    const periodTimes = ["08:30 - 09:20", "09:20 - 10:10", "10:10 - 11:00", "11:00 - 11:50", "13:00 - 13:50", "13:50 - 14:40", "14:40 - 15:30"];
    const daysMap = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
    const todayKey = daysMap[new Date().getDay()];

    onSnapshot(doc(db, "rm_config", "schedule"), (docSnap) => {
        const list = document.getElementById('schedule-list');
        if (docSnap.exists() && docSnap.data()[todayKey]) {
            const subjects = docSnap.data()[todayKey]; 
            if(Array.isArray(subjects) && subjects.length > 0) {
                 list.innerHTML = subjects.map((subj, i) => `
                    <div class="schedule-item ${isCurrentPeriod(i) ? 'active':''}">
                        <span class="time-badge">${periodTimes[i]}</span>
                        <div class="fw-bold text-dark"><span class="subject-code">${subj.code || '-'}</span> ${subj.name || '‡∏ß‡πà‡∏≤‡∏á'}</div>
                        <div class="teacher-room"><i class="fa-solid fa-user me-1"></i> ${subj.teacher || '-'} | <i class="fa-solid fa-location-dot me-1"></i> ${subj.room || '-'}</div>
                    </div>`).join('');
            } else { list.innerHTML = '<div class="text-center text-muted small py-3">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>'; }
        } else { list.innerHTML = '<div class="text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>'; }
    });

    function isCurrentPeriod(index) {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const times = periodTimes[index].split(' - ')[0].split(':');
        const start = parseInt(times[0]) * 60 + parseInt(times[1]);
        const endTimes = periodTimes[index].split(' - ')[1].split(':');
        const end = parseInt(endTimes[0]) * 60 + parseInt(endTimes[1]);
        return currentTime >= start && currentTime < end;
    }

    // --- HOMEWORK LOGIC (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å) ---
    const hwList = document.getElementById('homework-list');
    const qHw = query(collection(db, "rm_homeworks"), orderBy("date", "asc"));
    onSnapshot(qHw, (snapshot) => {
        if(snapshot.empty) { hwList.innerHTML = '<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</div>'; return; }
        hwList.innerHTML = "";
        snapshot.forEach((doc) => {
            const hw = doc.data();
            const isUrgent = hw.type === 'urgent' ? 'hw-urgent' : 'hw-normal';
            const badge = hw.type === 'urgent' ? '<span class="badge bg-danger mb-1" style="font-size: 0.6rem;">‡∏î‡πà‡∏ß‡∏ô!</span>' : `<span class="badge bg-warning text-dark mb-1" style="font-size: 0.6rem;">‡∏™‡πà‡∏á ${hw.date}</span>`;
            hwList.innerHTML += `<div class="custom-card hw-item ${isUrgent} p-3 mb-2 position-relative"><i class="fa-solid fa-trash btn-delete-hw" onclick="deleteHomework('${doc.id}')"></i><div class="d-flex justify-content-between"><div>${badge}<div class="fw-bold">${hw.desc}</div><div class="text-muted small">${hw.subject}</div></div></div></div>`;
        });
    }, (error) => {
        console.error("Error fetching homework:", error);
        hwList.innerHTML = `<div class="text-center text-danger small py-3">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}</div>`;
    });

    window.saveHomework = async () => {
        const subject = document.getElementById('hw-subject').value;
        const desc = document.getElementById('hw-desc').value;
        const date = document.getElementById('hw-date').value;
        const type = document.getElementById('hw-type').value;
        
        if(!subject || !desc) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        
        try {
            await addDoc(collection(db, "rm_homeworks"), { subject, desc, date, type, createdAt: serverTimestamp() });
            
            // ‚úÖ ‡πÉ‡∏ä‡πâ getOrCreateInstance ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
            const modalEl = document.getElementById('addHomeworkModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();
            
            document.getElementById('hw-form').reset();
        } catch (e) {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }
    }
    
    window.deleteHomework = async (id) => { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "rm_homeworks", id)); }

    // --- Teacher & Other Logic (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏Ç‡∏≠‡∏•‡∏∞‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
    let currentScheduleData = {};
    window.loadScheduleForDay = () => {
        const day = document.getElementById('edit-day-select').value;
        const container = document.getElementById('period-forms-container');
        const dataForDay = currentScheduleData[day] || [];
        container.innerHTML = periodTimes.map((time, i) => {
            const d = dataForDay[i] || {};
            return `<div class="card p-2 bg-light border mb-2"><div class="fw-bold small mb-1 text-primary">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${i+1} (${time})</div><div class="row g-2"><div class="col-4"><input type="text" class="form-control form-control-sm p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" value="${d.code || ''}"></div><div class="col-8"><input type="text" class="form-control form-control-sm p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" value="${d.name || ''}"></div><div class="col-6"><input type="text" class="form-control form-control-sm p-teacher" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π" value="${d.teacher || ''}"></div><div class="col-6"><input type="text" class="form-control form-control-sm p-room" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" value="${d.room || ''}"></div></div></div>`;
        }).join('');
    }

    window.saveScheduleByDay = async () => {
        const day = document.getElementById('edit-day-select').value;
        const periods = [];
        document.getElementById('period-forms-container').querySelectorAll('.card').forEach(card => {
            periods.push({
                code: card.querySelector('.p-code').value.trim(),
                name: card.querySelector('.p-name').value.trim(),
                teacher: card.querySelector('.p-teacher').value.trim(),
                room: card.querySelector('.p-room').value.trim()
            });
        });
        const updateData = {}; updateData[day] = periods;
        await setDoc(doc(db, "rm_config", "schedule"), updateData, { merge: true });
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô${day}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
    }

    window.addStudent = async () => {
        const id = document.getElementById('new-student-id').value.trim();
        const name = document.getElementById('new-student-name').value.trim();
        const group = document.getElementById('new-student-group').value;
        const file = document.getElementById('new-student-photo').files[0];
        if(!id || !name) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        const btn = document.getElementById('btn-add-student');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;
        try {
            let photoURL = "";
            if (file) {
                const snap = await uploadBytes(ref(storage, `student_photos/${id}_${Date.now()}.jpg`), file);
                photoURL = await getDownloadURL(snap.ref);
            }
            await setDoc(doc(db, "rm_students", id), { name, photoURL, group: group || "1", xp: 0, level: 1, createdAt: serverTimestamp() });
            document.getElementById('new-student-id').value = "";
            document.getElementById('new-student-name').value = "";
            document.getElementById('new-student-photo').value = "";
        } catch(e) { alert("Error: " + e.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
    }
    
    window.updateStudentGroup = async (uid, newGroup) => {
        const ref = doc(db, "rm_students", uid);
        await updateDoc(ref, { group: newGroup });
    }

    window.triggerCamera = () => document.getElementById('camera-input').click();
    window.uploadDutyPhoto = async (input) => {
        const file = input.files[0];
        if(!file) return;
        alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...");
        try {
            const snap = await uploadBytes(ref(storage, 'duty/'+Date.now()+'.jpg'), file);
            const url = await getDownloadURL(snap.ref);
            await addDoc(collection(db, "rm_logs"), { type: 'duty', imageUrl: url, timestamp: serverTimestamp() });
            alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
        } catch(e) { alert("Upload Failed: " + e.message); }
    }

    window.unlockTeacherMode = () => new bootstrap.Modal(document.getElementById('teacherLoginModal')).show();
    window.checkTeacherPin = () => {
        if(document.getElementById('teacher-pin').value === "1234") {
            bootstrap.Modal.getInstance(document.getElementById('teacherLoginModal')).hide();
            new bootstrap.Modal(document.getElementById('teacherDashboardModal')).show();
            loadTeacherStudents(); 
            getDoc(doc(db, "rm_config", "schedule")).then(snap => {
                if(snap.exists()) {
                    currentScheduleData = snap.data();
                    document.getElementById('edit-day-select').value = 'mon';
                    loadScheduleForDay(); 
                }
            });
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
    }
    window.showSection = (id) => {
        ['teacher-menu', 'teacher-students', 'teacher-schedule', 'duty-photo-gallery'].forEach(el => document.getElementById(el).classList.add('d-none'));
        document.getElementById(id).classList.remove('d-none');
    }
    
    function loadTeacherStudents() {
        const container = document.getElementById('student-list-container');
        const q = query(collection(db, "rm_students")); 
        onSnapshot(q, (snap) => {
            container.innerHTML = "";
            const students = [];
            snap.forEach(d => students.push({ id: d.id, ...d.data() }));
            students.sort((a, b) => a.id.localeCompare(b.id)); 
            students.forEach(s => {
                const imgDisplay = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                const { level, rank } = getLevelInfo(s.xp || 0);
                const groupSelect = `<select class="form-select form-select-sm border-0 bg-light" style="width: auto; font-size: 0.7rem;" onchange="updateStudentGroup('${s.id}', this.value)"><option value="1" ${s.group=='1'?'selected':''}>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2" ${s.group=='2'?'selected':''}>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3" ${s.group=='3'?'selected':''}>‡∏û‡∏∏‡∏ò</option><option value="4" ${s.group=='4'?'selected':''}>‡∏û‡∏§‡∏´‡∏±‡∏™</option><option value="5" ${s.group=='5'?'selected':''}>‡∏®‡∏∏‡∏Å‡∏£‡πå</option></select>`;
                container.innerHTML += `<div class="d-flex justify-content-between align-items-center border-bottom p-2"><div class="d-flex align-items-center" style="overflow: hidden;"><img src="${imgDisplay}" class="student-list-img me-2 flex-shrink-0"><div style="min-width: 0;"><div class="d-flex align-items-center mb-1"><span class="badge bg-secondary me-1" style="font-size:0.6rem">${s.id}</span><strong class="text-truncate" style="font-size:0.85rem">${s.name}</strong></div><div class="d-flex align-items-center flex-wrap gap-1"><span class="badge bg-primary" style="font-size:0.6rem">Lv.${level}</span>${groupSelect}<span class="xp-badge">${s.xp} XP</span></div></div></div><div class="d-flex flex-column gap-1 ms-2"><button class="btn btn-sm btn-outline-success py-0" style="font-size:0.7rem" onclick="giveXP('${s.id}', 10)">+10</button><button class="btn btn-sm btn-outline-danger py-0" style="font-size:0.7rem" onclick="giveXP('${s.id}', -10)">-10</button></div></div>`;
            });
        });
    }
    
    window.giveXP = async (uid, amount) => {
        const ref = doc(db, "rm_students", uid);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            const current = snap.data().xp || 0;
            const newXP = Math.max(0, current + amount);
            const { level } = getLevelInfo(newXP);
            await updateDoc(ref, { xp: newXP, level: level });
        }
    }

    window.viewDutyHistory = async () => {
        window.showSection('duty-photo-gallery');
        const gallery = document.getElementById('gallery-grid');
        gallery.innerHTML = "Loading...";
        const q = query(collection(db, "rm_logs"), orderBy("timestamp", "desc"), limit(20));
        onSnapshot(q, (snap) => {
            gallery.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(data.imageUrl) gallery.innerHTML += `<img src="${data.imageUrl}" class="w-100 rounded border mb-2">`;
            });
        });
    }

    window.openDutyRosterModal = () => {
        new bootstrap.Modal(document.getElementById('dutyRosterModal')).show();
        loadAllDutyMembers();
    }

    function loadAllDutyMembers() {
        const q = query(collection(db, "rm_students"));
        onSnapshot(q, (snap) => {
            const days = { '1': [], '2': [], '3': [], '4': [], '5': [] };
            snap.forEach(d => {
                const s = d.data();
                const g = s.group || '1';
                if(days[g]) days[g].push(s);
            });
            const targets = { '1': 'd-mon', '2': 'd-tue', '3': 'd-wed', '4': 'd-thu', '5': 'd-fri' };
            for(let g in days) {
                const container = document.getElementById(targets[g]);
                if(!container) continue;
                if(days[g].length === 0) { container.innerHTML = '<div class="text-center py-4 text-muted opacity-50">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>'; continue; }
                let html = '<div class="list-group shadow-sm rounded-3 overflow-hidden border-0">';
                days[g].forEach(s => {
                    const img = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                    html += `<div class="list-group-item border-0 border-bottom py-3 d-flex align-items-center"><img src="${img}" class="rounded-circle me-3 border" width="40" height="40" style="object-fit:cover;"><div><div class="fw-bold text-dark">${s.name}</div><div class="small text-muted"><i class="fa-solid fa-star text-warning me-1"></i>${s.xp || 0} XP</div></div></div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        });
    }

    // Duty Badge Logic
    const currentDayIndex = new Date().getDay();
    const dutyGroupBadge = document.getElementById('duty-group');
    let todayGroup = currentDayIndex;
    if(todayGroup === 0 || todayGroup === 6) todayGroup = 1;

    const dutyConfig = {
        1: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", color: "#fbbf24", textColor: "#000" },
        2: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", color: "#f472b6", textColor: "#fff" },
        3: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", color: "#22c55e", textColor: "#fff" },
        4: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", color: "#fb923c", textColor: "#fff" },
        5: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå", color: "#3b82f6", textColor: "#fff" }
    };

    const config = dutyConfig[todayGroup] || dutyConfig[1];
    dutyGroupBadge.innerText = config.text;
    dutyGroupBadge.classList.remove('bg-success'); 
    dutyGroupBadge.style.backgroundColor = config.color;
    dutyGroupBadge.style.color = config.textColor;
    
    const qDuty = query(collection(db, "rm_students"), where("group", "==", String(todayGroup)));
    onSnapshot(qDuty, (snap) => {
        const container = document.getElementById('duty-list-text');
        if(snap.empty) {
            container.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£";
        } else {
            let html = '<div class="d-flex align-items-center ps-2">'; 
            snap.forEach(d => {
                const s = d.data();
                const img = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                html += `<img src="${img}" class="rounded-circle border border-white" style="width:35px; height:35px; object-fit:cover; margin-left: -10px;" title="${s.name}">`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    });

    window.toggleFab = () => document.getElementById('fabMenu').classList.toggle('active');

</script>