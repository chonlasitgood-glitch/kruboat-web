<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomMate - Student App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíª</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary-color: #6366f1; --secondary-color: #ec4899; --bg-color: #f3f4f6; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --fab-text-bg: #374151; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 100px; }
        .mobile-container { max-width: 480px; margin: 0 auto; background-color: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        .app-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; margin-bottom: 20px; position: relative; }
        .profile-section img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); object-fit: cover; background: white; }
        .xp-bar { height: 8px; background-color: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .xp-progress { height: 100%; background-color: #fbbf24; width: 0%; transition: width 0.5s; }
        .custom-card { border: none; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 15px; overflow: hidden; background: white; }
        .card-header-custom { padding: 12px 15px; font-weight: 600; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        
        /* Schedule Item Styles (Updated) */
        .schedule-item { padding: 12px 15px; border-left: 4px solid #e5e7eb; margin-bottom: 8px; background-color: #f9fafb; border-radius: 0 8px 8px 0; transition: all 0.3s; }
        .schedule-item.active { border-left: 4px solid var(--primary-color); background-color: #eef2ff; transform: translateX(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .time-badge { font-size: 0.7rem; color: #6b7280; display: block; margin-bottom: 2px; font-weight: 500; }
        .subject-code { font-size: 0.7rem; background: #e0e7ff; color: #4338ca; padding: 1px 6px; border-radius: 4px; margin-right: 5px; font-weight: 600; }
        .teacher-room { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }
        
        .hw-item { border-left: 4px solid transparent; position: relative; }
        .hw-urgent { border-left-color: #ef4444; }
        .hw-normal { border-left-color: #fbbf24; }
        .hw-done { border-left-color: #10b981; opacity: 0.6; }
        .btn-delete-hw { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #9ca3af; cursor: pointer; }
        .btn-delete-hw:hover { color: #ef4444; }
        .fab-container { position: fixed; bottom: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .fab-trigger { width: 45px; height: 45px; background-color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 18px; cursor: pointer; border: none; transition: all 0.3s; }
        .fab-menu { display: flex; flex-direction: column-reverse; align-items: flex-end; gap: 12px; opacity: 0; pointer-events: none; transform: translateY(10px); transition: all 0.3s ease-in-out; margin-bottom: 5px; }
        .fab-container.active .fab-menu { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .fab-item { display: flex; align-items: center; justify-content: flex-end; gap: 10px; text-decoration: none; cursor: pointer; }
        .fab-item-btn { width: 35px; height: 35px; background-color: white; border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 14px; transition: background-color 0.2s; }
        .fab-item-label { background-color: var(--fab-text-bg); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.15); opacity: 0.9; font-weight: 400; }
        .fab-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .fab-container.active ~ .fab-overlay { opacity: 1; pointer-events: auto; }
        .add-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: none; }
        .teacher-btn { position: absolute; top: 20px; right: 20px; color: rgba(255,255,255,0.6); cursor: pointer; }
        .teacher-btn:hover { color: white; }
        .xp-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #fbbf24; color: #78350f; font-weight: bold; margin-left: 5px;}
        .student-list-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }

        /* Tab Style in Modal */
        .nav-pills .nav-link { color: #6b7280; background-color: #f3f4f6; margin: 0 2px; }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="mobile-container">
    <!-- Header -->
    <header class="app-header">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="fw-bold fs-5"><i class="fa-solid fa-shapes me-2"></i>RoomMate</div>
            <div class="teacher-btn" onclick="unlockTeacherMode()"><i class="fa-solid fa-gear"></i></div>
        </div>
        <div class="d-flex align-items-center profile-section">
            <img src="https://ui-avatars.com/api/?name=Guest&background=random" alt="Profile" id="student-img">
            <div class="ms-3 flex-grow-1">
                <div class="fw-bold" id="student-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                <div class="d-flex justify-content-between align-items-end" style="font-size: 0.8rem;">
                    <span id="student-lvl">Lv. 1</span>
                    <span id="student-xp">0 XP</span>
                </div>
                <div class="xp-bar"><div class="xp-progress" id="student-xp-bar" style="width: 0%"></div></div>
            </div>
        </div>
    </header>

    <div class="container px-3">
        
        <!-- Schedule Card -->
        <div class="custom-card">
            <div class="card-header-custom">
                <span><i class="fa-regular fa-calendar-days me-2 text-primary"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                <span class="badge bg-primary rounded-pill" id="today-day">-</span>
            </div>
            <div class="p-3" id="schedule-list">
                <div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</div>
            </div>
        </div>

        <!-- Duty Card (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß) -->
        <div class="custom-card border-0" style="background: linear-gradient(to right, #fff1eb, #ace0f9);">
            <div class="card-header-custom bg-transparent border-0">
                <span><i class="fa-solid fa-broom me-2 text-success"></i>‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</span>
                <div class="d-flex align-items-center gap-2">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏π‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
                    <button class="btn btn-light btn-sm rounded-pill px-3 py-1 border-0 shadow-sm text-success fw-bold" style="font-size: 0.7rem;" onclick="openDutyRosterModal()">
                        <i class="fa-solid fa-users-viewfinder me-1"></i> ‡∏î‡∏π‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                    </button>
                    <span class="badge bg-success" id="duty-group">-</span>
                </div>
            </div>
            <div class="p-3 pt-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="duty-members">
                        <small class="text-muted d-block mb-1">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£:</small>
                        <div id="duty-list-text" class="small text-dark fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                    <button class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm" onclick="triggerCamera()">
                        <i class="fa-solid fa-camera me-1"></i> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô
                    </button>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="uploadDutyPhoto(this)">
                </div>
            </div>
        </div>

        <!-- Homework List -->
        <div class="d-flex justify-content-between align-items-center mb-2 mt-4">
            <h6 class="fw-bold m-0"><i class="fa-solid fa-pen-to-square me-2 text-warning"></i>‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h6>
            <button class="btn btn-dark add-btn shadow-sm" data-bs-toggle="modal" data-bs-target="#addHomeworkModal"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="homework-list">
            <div class="text-center text-muted small py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>

    </div>
    <div style="height: 60px;"></div>
</div>

<!-- FAB Menu -->
<div class="fab-container" id="fabMenu">
    <div class="fab-menu">
        <div class="fab-item" onclick="logoutStudent()">
            <span class="fab-item-label">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <div class="fab-item-btn bg-danger text-white"><i class="fa-solid fa-right-from-bracket"></i></div>
        </div>
        <a href="../student/index.html" class="fab-item">
            <span class="fab-item-label">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            <div class="fab-item-btn"><i class="fa-solid fa-house"></i></div>
        </a>
    </div>
    <button class="fab-trigger" onclick="toggleFab()"><i class="fa-solid fa-bars"></i></button>
</div>
<div class="fab-overlay" onclick="toggleFab()"></div>

<!-- Modal: Duty Roster (‡πÉ‡∏´‡∏°‡πà) -->
<div class="modal fade" id="dutyRosterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0" style="min-height: 500px;">
            <div class="modal-header border-0 bg-success text-white">
                <h6 class="modal-title fw-bold"><i class="fa-solid fa-broom me-2"></i>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <!-- Day Selector -->
                <ul class="nav nav-pills nav-fill mb-3 gap-1 small" id="duty-tabs" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active rounded-pill py-1" id="d-mon-tab" data-bs-toggle="pill" data-bs-target="#d-mon" type="button">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link rounded-pill py-1" id="d-tue-tab" data-bs-toggle="pill" data-bs-target="#d-tue" type="button">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link rounded-pill py-1" id="d-wed-tab" data-bs-toggle="pill" data-bs-target="#d-wed" type="button">‡∏û‡∏∏‡∏ò</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link rounded-pill py-1" id="d-thu-tab" data-bs-toggle="pill" data-bs-target="#d-thu" type="button">‡∏û‡∏§‡∏´‡∏±‡∏™</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link rounded-pill py-1" id="d-fri-tab" data-bs-toggle="pill" data-bs-target="#d-fri" type="button">‡∏®‡∏∏‡∏Å‡∏£‡πå</button></li>
                </ul>
                
                <div class="tab-content" id="duty-tabContent">
                    <div class="tab-pane fade show active" id="d-mon" role="tabpanel"><div class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
                    <div class="tab-pane fade" id="d-tue" role="tabpanel"><div class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
                    <div class="tab-pane fade" id="d-wed" role="tabpanel"><div class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
                    <div class="tab-pane fade" id="d-thu" role="tabpanel"><div class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
                    <div class="tab-pane fade" id="d-fri" role="tabpanel"><div class="text-center py-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Student Register -->
<div class="modal fade" id="studentRegisterModal" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 p-4 text-center">
            <div class="mb-3"><i class="fa-solid fa-user-lock text-5xl text-primary"></i></div>
            <h4 class="fw-bold mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà RoomMate!</h4>
            <p class="text-muted small mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            <input type="text" id="reg-student-id" class="form-control text-center mb-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô4‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 7210)">
            <button class="btn btn-primary w-100 rounded-pill" onclick="registerStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            <p class="text-muted small mt-3" style="font-size: 0.7rem;">*‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÇ‡∏ö‡πä‡∏ó</p>
        </div>
    </div>
</div>

<!-- Modal: Add Homework -->
<div class="modal fade" id="addHomeworkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="hw-form">
                    <div class="mb-3"><label class="form-label small text-muted">‡∏ß‡∏¥‡∏ä‡∏≤</label><input type="text" id="hw-subject" class="form-control form-control-sm bg-light border-0"></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="hw-desc" class="form-control form-control-sm bg-light border-0" rows="2"></textarea></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label><input type="date" id="hw-date" class="form-control form-control-sm bg-light border-0"></div>
                    <div class="mb-3"><label class="form-label small text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</label>
                        <select id="hw-type" class="form-select form-select-sm bg-light border-0"><option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option><option value="urgent">‡∏î‡πà‡∏ß‡∏ô (‡∏™‡∏µ‡πÅ‡∏î‡∏á)</option></select>
                    </div>
                    <button type="button" class="btn btn-primary w-100 rounded-pill btn-sm" onclick="saveHomework()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Teacher Login -->
<div class="modal fade" id="teacherLoginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center">
                <input type="password" id="teacher-pin" class="form-control form-control-lg text-center tracking-widest mb-3" placeholder="PIN" maxlength="5">
                <button class="btn btn-primary w-100 rounded-pill" onclick="checkTeacherPin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Teacher Dashboard -->
<div class="modal fade" id="teacherDashboardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0" style="min-height: 600px;">
            <div class="modal-header border-0 bg-primary text-white">
                <h6 class="modal-title fw-bold" id="teacher-modal-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0">
                <!-- Teacher Menu -->
                <div id="teacher-menu" class="p-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="showSection('teacher-students')">
                            <i class="fa-solid fa-users me-2 text-success"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                        </button>
                        <button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="showSection('teacher-schedule')">
                            <i class="fa-solid fa-calendar-days me-2 text-primary"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button class="btn btn-white shadow-sm text-start p-3 rounded-3 border" onclick="viewDutyHistory()">
                            <i class="fa-solid fa-images me-2 text-warning"></i> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£
                        </button>
                    </div>
                </div>

                <!-- Section: Manage Students -->
                <div id="teacher-students" class="d-none h-100 d-flex flex-column">
                    <div class="p-2 border-bottom bg-white d-flex align-items-center">
                        <button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button>
                        <span class="fw-bold small">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </div>
                    <div class="p-3 bg-white border-bottom">
                        <div class="mb-2">
                            <input type="text" id="new-student-id" class="form-control form-control-sm mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (ID)">
                            <input type="text" id="new-student-name" class="form-control form-control-sm mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            <select id="new-student-group" class="form-select form-select-sm mb-2">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏£ --</option>
                                <option value="1">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                                <option value="2">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                                <option value="3">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option>
                                <option value="4">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                                <option value="5">‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                            </select>
                            <label class="form-label small text-muted mb-1">‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                            <input type="file" id="new-student-photo" class="form-control form-control-sm mb-2" accept="image/*">
                            <button id="btn-add-student" class="btn btn-success btn-sm w-100 rounded-pill" onclick="addStudent()">
                                <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>
                    </div>
                    <div id="student-list-container" class="p-2 overflow-auto flex-grow-1"></div>
                </div>

                <!-- Section: Edit Schedule -->
                <div id="teacher-schedule" class="d-none h-100 d-flex flex-column">
                    <div class="p-2 border-bottom bg-white d-flex align-items-center">
                        <button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button>
                        <span class="fw-bold small">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </div>
                    <div class="p-3 overflow-auto flex-grow-1">
                        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô -->
                        <div class="mb-3">
                            <label class="form-label small fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
                            <select id="edit-day-select" class="form-select form-select-sm" onchange="loadScheduleForDay()">
                                <option value="mon">‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                                <option value="tue">‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                                <option value="wed">‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option>
                                <option value="thu">‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                                <option value="fri">‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                            </select>
                        </div>
                        
                        <!-- Form 7 ‡∏Ñ‡∏≤‡∏ö -->
                        <div id="period-forms-container" class="space-y-3">
                            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                        </div>

                        <button class="btn btn-primary w-100 rounded-pill btn-sm mt-3" onclick="saveScheduleByDay()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                    </div>
                </div>

                <!-- Section: Gallery -->
                <div id="duty-photo-gallery" class="d-none h-100 d-flex flex-column">
                     <div class="p-2 border-bottom bg-white d-flex align-items-center">
                        <button class="btn btn-sm btn-link text-decoration-none me-2" onclick="showSection('teacher-menu')"><i class="fa-solid fa-arrow-left"></i></button>
                        <span class="fw-bold small">‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏£</span>
                    </div>
                    <div id="gallery-grid" class="d-grid gap-2 p-2 overflow-auto" style="grid-template-columns: 1fr 1fr;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, serverTimestamp, getDoc, updateDoc, setDoc, limit, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ‚ö†Ô∏è Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
    const firebaseConfig = {
        apiKey: "AIzaSyAlfZHbCFxGK3p3nDoAPy3m9KqZzmX2s9I",
        authDomain: "kruboat-web.firebaseapp.com",
        projectId: "kruboat-web",
        storageBucket: "kruboat-web.firebasestorage.app",
        messagingSenderId: "61868765546",
        appId: "1:61868765546:web:683b18ddf68c89dd317513"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUserData = null;
    let currentStudentId = null;

    // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 7 ‡∏Ñ‡∏≤‡∏ö
    const periodTimes = [
        "08:30 - 09:20", "09:20 - 10:10", "10:10 - 11:00", 
        "11:00 - 11:50", "13:00 - 13:50", "13:50 - 14:40", "14:40 - 15:30"
    ];

    // 1. Auth & Identity Logic
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const storedId = localStorage.getItem('roommate_student_id');
            if (storedId) {
                currentStudentId = storedId;
                loadUserProfile(storedId);
            } else {
                const regModal = new bootstrap.Modal(document.getElementById('studentRegisterModal'));
                regModal.show();
            }
        } else {
            signInAnonymously(auth).catch((error) => console.error("Auth Error", error));
        }
    });

    window.registerStudent = async () => {
        const id = document.getElementById('reg-student-id').value.trim();
        if(!id) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
        
        const docRef = doc(db, "rm_students", id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            localStorage.setItem('roommate_student_id', id);
            bootstrap.Modal.getInstance(document.getElementById('studentRegisterModal')).hide();
            currentStudentId = id;
            loadUserProfile(id);
        } else {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        }
    }

    async function loadUserProfile(id) {
        const userRef = doc(db, "rm_students", id);
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                updateProfileUI();
            } else {
                alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö");
                localStorage.removeItem('roommate_student_id');
                location.reload();
            }
        });
    }

    function updateProfileUI() {
        if(!currentUserData) return;
        document.getElementById('student-name').innerText = currentUserData.name;
        const imgUrl = currentUserData.photoURL ? currentUserData.photoURL : `https://ui-avatars.com/api/?name=${currentUserData.name}&background=random`;
        document.getElementById('student-img').src = imgUrl;
        document.getElementById('student-lvl').innerText = `Lv. ${currentUserData.level || 1}`;
        document.getElementById('student-xp').innerText = `${currentUserData.xp || 0}/100 XP`;
        document.getElementById('student-xp-bar').style.width = `${Math.min(currentUserData.xp || 0, 100)}%`;
    }
    
    window.logoutStudent = () => {
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            localStorage.removeItem('roommate_student_id');
            location.reload();
        }
    }

    // 2. Schedule Logic
    const daysMap = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"];
    const todayKey = daysMap[new Date().getDay()];
    
    onSnapshot(doc(db, "rm_config", "schedule"), (docSnap) => {
        const list = document.getElementById('schedule-list');
        if (docSnap.exists() && docSnap.data()[todayKey]) {
            const subjects = docSnap.data()[todayKey]; // Now expects an array of objects
            
            if(Array.isArray(subjects) && subjects.length > 0) {
                 list.innerHTML = subjects.map((subj, i) => `
                    <div class="schedule-item ${isCurrentPeriod(i) ? 'active':''}">
                        <span class="time-badge">${periodTimes[i]}</span>
                        <div class="fw-bold text-dark">
                            <span class="subject-code">${subj.code || '-'}</span> ${subj.name || '‡∏ß‡πà‡∏≤‡∏á'}
                        </div>
                        <div class="teacher-room">
                            <i class="fa-solid fa-user me-1"></i> ${subj.teacher || '-'} | 
                            <i class="fa-solid fa-location-dot me-1"></i> ${subj.room || '-'}
                        </div>
                    </div>
                `).join('');
            } else {
                 list.innerHTML = '<div class="text-center text-muted small py-3">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>';
            }
        } else {
            list.innerHTML = '<div class="text-center text-muted small py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>';
        }
    });

    function isCurrentPeriod(index) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ highlight (‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
        const now = new Date();
        const currentHour = now.getHours();
        const currentMin = now.getMinutes();
        const currentTime = currentHour * 60 + currentMin;
        
        const times = periodTimes[index].split(' - ')[0].split(':');
        const start = parseInt(times[0]) * 60 + parseInt(times[1]);
        const endTimes = periodTimes[index].split(' - ')[1].split(':');
        const end = parseInt(endTimes[0]) * 60 + parseInt(endTimes[1]);
        
        return currentTime >= start && currentTime < end;
    }

    // Teacher: Schedule Editor Logic
    let currentScheduleData = {};

    window.loadScheduleForDay = () => {
        const day = document.getElementById('edit-day-select').value;
        const container = document.getElementById('period-forms-container');
        const dataForDay = currentScheduleData[day] || [];
        
        container.innerHTML = periodTimes.map((time, i) => {
            const d = dataForDay[i] || {};
            return `
                <div class="card p-2 bg-light border mb-2">
                    <div class="fw-bold small mb-1 text-primary">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${i+1} (${time})</div>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" class="form-control form-control-sm p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" value="${d.code || ''}">
                        </div>
                        <div class="col-8">
                            <input type="text" class="form-control form-control-sm p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" value="${d.name || ''}">
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm p-teacher" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π" value="${d.teacher || ''}">
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control form-control-sm p-room" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" value="${d.room || ''}">
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.saveScheduleByDay = async () => {
        const day = document.getElementById('edit-day-select').value;
        const container = document.getElementById('period-forms-container');
        const periods = [];
        
        // Loop ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å 7 ‡∏Ñ‡∏≤‡∏ö
        container.querySelectorAll('.card').forEach(card => {
            periods.push({
                code: card.querySelector('.p-code').value.trim(),
                name: card.querySelector('.p-name').value.trim(),
                teacher: card.querySelector('.p-teacher').value.trim(),
                room: card.querySelector('.p-room').value.trim()
            });
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        const updateData = {};
        updateData[day] = periods;
        
        await setDoc(doc(db, "rm_config", "schedule"), updateData, { merge: true });
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô${day}‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
    }

    // Teacher: Add Student
    window.addStudent = async () => {
        const id = document.getElementById('new-student-id').value.trim();
        const name = document.getElementById('new-student-name').value.trim();
        const group = document.getElementById('new-student-group').value;
        const fileInput = document.getElementById('new-student-photo');
        const file = fileInput.files[0];
        
        if(!id || !name) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        
        const btn = document.getElementById('btn-add-student');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            let photoURL = "";
            if (file) {
                const storageRef = ref(storage, `student_photos/${id}_${Date.now()}.jpg`);
                const snapshot = await uploadBytes(storageRef, file);
                photoURL = await getDownloadURL(snapshot.ref);
            }

            await setDoc(doc(db, "rm_students", id), {
                name: name,
                photoURL: photoURL,
                group: group || "1",
                xp: 0,
                level: 1,
                createdAt: serverTimestamp()
            });
            
            document.getElementById('new-student-id').value = "";
            document.getElementById('new-student-name').value = "";
            document.getElementById('new-student-group').value = "";
            fileInput.value = "";
            
        } catch(e) {
            alert("Error: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    window.updateStudentGroup = async (uid, newGroup) => {
        const ref = doc(db, "rm_students", uid);
        await updateDoc(ref, { group: newGroup });
    }

    // 3. Homework Logic
    const hwList = document.getElementById('homework-list');
    const qHw = query(collection(db, "rm_homeworks"), orderBy("date", "asc"));
    onSnapshot(qHw, (snapshot) => {
        if(snapshot.empty) { hwList.innerHTML = '<div class="text-center text-muted small py-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</div>'; return; }
        hwList.innerHTML = "";
        snapshot.forEach((doc) => {
            const hw = doc.data();
            const isUrgent = hw.type === 'urgent' ? 'hw-urgent' : 'hw-normal';
            const badge = hw.type === 'urgent' ? '<span class="badge bg-danger mb-1" style="font-size: 0.6rem;">‡∏î‡πà‡∏ß‡∏ô!</span>' : `<span class="badge bg-warning text-dark mb-1" style="font-size: 0.6rem;">‡∏™‡πà‡∏á ${hw.date}</span>`;
            hwList.innerHTML += `
                <div class="custom-card hw-item ${isUrgent} p-3 mb-2 position-relative">
                    <i class="fa-solid fa-trash btn-delete-hw" onclick="deleteHomework('${doc.id}')"></i>
                    <div class="d-flex justify-content-between"><div>${badge}<div class="fw-bold">${hw.desc}</div><div class="text-muted small">${hw.subject}</div></div></div>
                </div>`;
        });
    });

    window.saveHomework = async () => {
        const subject = document.getElementById('hw-subject').value;
        const desc = document.getElementById('hw-desc').value;
        const date = document.getElementById('hw-date').value;
        const type = document.getElementById('hw-type').value;
        if(!subject || !desc) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        await addDoc(collection(db, "rm_homeworks"), { subject, desc, date, type, createdAt: serverTimestamp() });
        bootstrap.Modal.getInstance(document.getElementById('addHomeworkModal')).hide();
        document.getElementById('hw-form').reset();
    }
    window.deleteHomework = async (id) => { if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "rm_homeworks", id)); }

    // 5. Duty & Teacher Functions
    window.triggerCamera = () => document.getElementById('camera-input').click();
    window.uploadDutyPhoto = async (input) => {
        const file = input.files[0];
        if(!file) return;
        alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...");
        try {
            const refFile = ref(storage, 'duty/'+Date.now()+'.jpg');
            const snap = await uploadBytes(refFile, file);
            const url = await getDownloadURL(snap.ref);
            await addDoc(collection(db, "rm_logs"), { type: 'duty', imageUrl: url, timestamp: serverTimestamp() });
            alert("‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
        } catch(e) { alert("Upload Failed: " + e.message); }
    }

    window.unlockTeacherMode = () => new bootstrap.Modal(document.getElementById('teacherLoginModal')).show();
    window.checkTeacherPin = () => {
        if(document.getElementById('teacher-pin').value === "admin") {
            bootstrap.Modal.getInstance(document.getElementById('teacherLoginModal')).hide();
            new bootstrap.Modal(document.getElementById('teacherDashboardModal')).show();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô & ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
            loadTeacherStudents(); 
            getDoc(doc(db, "rm_config", "schedule")).then(snap => {
                if(snap.exists()) {
                    currentScheduleData = snap.data();
                    // ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô Default
                    document.getElementById('edit-day-select').value = 'mon';
                    loadScheduleForDay(); 
                }
            });
            
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
    }
    window.showSection = (id) => {
        ['teacher-menu', 'teacher-students', 'teacher-schedule', 'duty-photo-gallery'].forEach(el => document.getElementById(el).classList.add('d-none'));
        document.getElementById(id).classList.remove('d-none');
    }
    
    // Load Students for Teacher
    function loadTeacherStudents() {
        const container = document.getElementById('student-list-container');
        const q = query(collection(db, "rm_students")); 
        
        onSnapshot(q, (snap) => {
            container.innerHTML = "";
            const students = [];
            snap.forEach(d => students.push({ id: d.id, ...d.data() }));
            students.sort((a, b) => a.id.localeCompare(b.id)); 

            students.forEach(s => {
                const imgDisplay = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                const currentGroup = s.group || "1";
                const groupSelect = `
                    <select class="form-select form-select-sm border-0 bg-light" style="width: auto; font-size: 0.7rem;" onchange="updateStudentGroup('${s.id}', this.value)">
                        <option value="1" ${currentGroup == '1' ? 'selected' : ''}>‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option>
                        <option value="2" ${currentGroup == '2' ? 'selected' : ''}>‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option>
                        <option value="3" ${currentGroup == '3' ? 'selected' : ''}>‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò</option>
                        <option value="4" ${currentGroup == '4' ? 'selected' : ''}>‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ</option>
                        <option value="5" ${currentGroup == '5' ? 'selected' : ''}>‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</option>
                    </select>`;

                container.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center border-bottom p-2">
                        <div class="d-flex align-items-center" style="overflow: hidden;">
                            <img src="${imgDisplay}" class="student-list-img me-2 flex-shrink-0">
                            <div style="min-width: 0;">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-secondary me-1" style="font-size:0.6rem">${s.id}</span>
                                    <strong class="text-truncate" style="font-size:0.85rem">${s.name}</strong> 
                                </div>
                                <div class="d-flex align-items-center">
                                    ${groupSelect}
                                    <span class="xp-badge ms-1">${s.xp} XP</span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-column gap-1 ms-2">
                            <button class="btn btn-sm btn-outline-success py-0" style="font-size:0.7rem" onclick="giveXP('${s.id}', 10)">+10</button>
                            <button class="btn btn-sm btn-outline-danger py-0" style="font-size:0.7rem" onclick="giveXP('${s.id}', -10)">-10</button>
                        </div>
                    </div>`;
            });
        });
    }
    
    window.giveXP = async (uid, amount) => {
        const ref = doc(db, "rm_students", uid);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            const current = snap.data().xp || 0;
            await updateDoc(ref, { xp: current + amount });
        }
    }

    window.viewDutyHistory = async () => {
        window.showSection('duty-photo-gallery');
        const gallery = document.getElementById('gallery-grid');
        gallery.innerHTML = "Loading...";
        const q = query(collection(db, "rm_logs"), orderBy("timestamp", "desc"), limit(20));
        onSnapshot(q, (snap) => {
            gallery.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                if(data.imageUrl) gallery.innerHTML += `<img src="${data.imageUrl}" class="w-100 rounded border mb-2">`;
            });
        });
    }

    // Init UI
    const daysTH = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏û‡∏∏‡∏ò", "‡∏û‡∏§‡∏´‡∏±‡∏™", "‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡πÄ‡∏™‡∏≤‡∏£‡πå"];
    const currentDayIndex = new Date().getDay();
    document.getElementById('today-day').innerText = daysTH[currentDayIndex];
    
    const dutyListText = document.getElementById('duty-list-text');
    const dutyGroupBadge = document.getElementById('duty-group');
    let todayGroup = currentDayIndex;
    if(todayGroup === 0 || todayGroup === 6) todayGroup = 1;

    const dutyConfig = {
        1: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", color: "#fbbf24", textColor: "#000" },
        2: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", color: "#f472b6", textColor: "#fff" },
        3: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", color: "#22c55e", textColor: "#fff" },
        4: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", color: "#fb923c", textColor: "#fff" },
        5: { text: "‡πÄ‡∏ß‡∏£‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå", color: "#3b82f6", textColor: "#fff" }
    };

    const config = dutyConfig[todayGroup] || dutyConfig[1];
    
    dutyGroupBadge.innerText = config.text;
    dutyGroupBadge.classList.remove('bg-success'); 
    dutyGroupBadge.style.backgroundColor = config.color;
    dutyGroupBadge.style.color = config.textColor;

    const qDuty = query(collection(db, "rm_students"), where("group", "==", String(todayGroup)));
    onSnapshot(qDuty, (snap) => {
        const container = document.getElementById('duty-list-text');
        if(snap.empty) {
            container.innerHTML = '<span class="small text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏ß‡∏£</span>';
        } else {
            let html = '<div class="d-flex align-items-center ps-2">'; 
            snap.forEach(d => {
                const s = d.data();
                const img = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                html += `<img src="${img}" class="rounded-circle border border-white" style="width:35px; height:35px; object-fit:cover; margin-left: -10px;" title="${s.name}">`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    });

    window.openDutyRosterModal = () => {
        new bootstrap.Modal(document.getElementById('dutyRosterModal')).show();
        loadAllDutyMembers();
    }

    function loadAllDutyMembers() {
        const q = query(collection(db, "rm_students"));
        onSnapshot(q, (snap) => {
            const days = { '1': [], '2': [], '3': [], '4': [], '5': [] };
            
            snap.forEach(d => {
                const s = d.data();
                const g = s.group || '1';
                if(days[g]) days[g].push(s);
            });

            const targets = { '1': 'd-mon', '2': 'd-tue', '3': 'd-wed', '4': 'd-thu', '5': 'd-fri' };
            
            for(let g in days) {
                const container = document.getElementById(targets[g]);
                if(!container) continue;
                
                if(days[g].length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-muted opacity-50"><i class="fa-solid fa-user-slash mb-2 fs-4"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>';
                    continue;
                }

                let html = '<div class="list-group shadow-sm rounded-3 overflow-hidden border-0">';
                days[g].forEach(s => {
                    const img = s.photoURL ? s.photoURL : `https://ui-avatars.com/api/?name=${s.name}&background=random`;
                    html += `
                        <div class="list-group-item border-0 border-bottom py-3 d-flex align-items-center">
                            <img src="${img}" class="rounded-circle me-3 border" width="40" height="40" style="object-fit:cover;">
                            <div>
                                <div class="fw-bold text-dark">${s.name}</div>
                                <div class="small text-muted"><i class="fa-solid fa-star text-warning me-1"></i>${s.xp || 0} XP</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
        });
    }

    window.toggleFab = () => document.getElementById('fabMenu').classList.toggle('active');

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>